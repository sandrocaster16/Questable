-- Таблица пользователей квестов
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  tg_id BIGINT,
  role ENUM('root', 'admin', 'user') NOT NULL DEFAULT 'user',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  deleted_at DATETIME NULL,
  banned DATETIME NULL
);

-- Таблица квестов
CREATE TABLE quests (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  deleted_at DATETIME NULL
);

-- Таблица станций
CREATE TABLE stations (
  id INT AUTO_INCREMENT PRIMARY KEY,
  quest_id INT NOT NULL,
  name VARCHAR(255) NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  deleted_at DATETIME NULL,
  FOREIGN KEY (quest_id) REFERENCES quests(id)
    ON DELETE CASCADE
);

-- Таблица вопросов
CREATE TABLE questions (
  id INT AUTO_INCREMENT PRIMARY KEY,
  station_id INT NOT NULL,
  question VARCHAR(2048) NOT NULL,
  answer LONGTEXT,
  help VARCHAR(2048) NULL,
  message VARCHAR(2048) NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  deleted_at DATETIME NULL,
  FOREIGN KEY (station_id) REFERENCES stations(id)
    ON DELETE CASCADE,
  CHECK (JSON_VALID(answer))
);

-- Таблица пользователей в контексте квестов
CREATE TABLE quest_users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  quest_id INT NOT NULL,
  role ENUM('player', 'owner', 'volunteer') NOT NULL DEFAULT 'player',
  command_id INT NULL,
  points INT DEFAULT 0,
  banned DATETIME NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id)
    ON DELETE CASCADE,
  FOREIGN KEY (quest_id) REFERENCES quests(id)
    ON DELETE CASCADE
);
